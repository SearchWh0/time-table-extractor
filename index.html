<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Time Table</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f5f3ef;
  --surface: #ffffff;
  --border: #e2ddd6;
  --text: #1a1714;
  --muted: #9a9590;
  --soft: #ede9e3;
  --shadow: 0 2px 12px rgba(0,0,0,0.07);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  min-height: 100vh;
}

/* â”€â”€ Header â”€â”€ */
.site-header {
  background: var(--text);
  padding: 28px 40px;
  display: flex;
  align-items: baseline;
  gap: 16px;
}
.site-title {
  font-size: 2.2rem;
  font-weight: 900;
  color: #fff;
  letter-spacing: -0.04em;
  line-height: 1;
}
.site-title span {
  color: #fff;
  opacity: 0.35;
}
.site-day {
  font-family: 'DM Mono', monospace;
  font-size: 0.75rem;
  color: rgba(255,255,255,0.4);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-left: auto;
}

/* â”€â”€ Paste zone â”€â”€ */
.paste-wrap {
  max-width: 800px;
  margin: 60px auto;
  padding: 0 24px;
  text-align: center;
}
.paste-zone {
  border: 2px dashed var(--border);
  border-radius: 16px;
  padding: 56px 40px;
  cursor: pointer;
  transition: border-color .2s, background .2s;
  background: var(--surface);
}
.paste-zone:hover {
  border-color: var(--text);
  background: var(--soft);
}
.paste-icon {
  font-size: 2.5rem;
  margin-bottom: 16px;
  opacity: 0.25;
}
.paste-zone h2 {
  font-size: 1.4rem;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--text);
}
.paste-zone p {
  font-size: 0.9rem;
  color: var(--muted);
  line-height: 1.6;
}
.key {
  display: inline-block;
  background: var(--soft);
  border: 1px solid var(--border);
  border-radius: 5px;
  padding: 1px 8px;
  font-family: 'DM Mono', monospace;
  font-size: 0.78rem;
  color: var(--text);
}

/* â”€â”€ Main app (shown after paste) â”€â”€ */
.app { display: none; }
.app.visible { display: block; }

/* â”€â”€ Class nav buttons â”€â”€ */
.class-nav-wrap {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 40px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow);
}
.class-nav {
  display: flex;
  gap: 4px;
  overflow-x: auto;
  padding: 12px 0;
  scrollbar-width: none;
}
.class-nav::-webkit-scrollbar { display: none; }

.class-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 18px;
  border-radius: 10px;
  border: 2px solid transparent;
  cursor: pointer;
  font-family: 'Outfit', sans-serif;
  font-size: 0.9rem;
  font-weight: 600;
  white-space: nowrap;
  transition: all .18s ease;
  background: var(--soft);
  color: var(--text);
  position: relative;
}
.class-btn .btn-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
  border: 1.5px solid rgba(0,0,0,0.12);
}
.class-btn:hover {
  background: var(--border);
  transform: translateY(-1px);
}
.class-btn.active {
  background: var(--text);
  color: #fff;
  border-color: var(--text);
  box-shadow: 0 4px 14px rgba(0,0,0,0.18);
}
.class-btn.active .btn-dot {
  border-color: rgba(255,255,255,0.3);
}

/* Name editing on button */
.class-btn .btn-label {
  outline: none;
  background: transparent;
  border: none;
  font: inherit;
  color: inherit;
  cursor: pointer;
  min-width: 40px;
  max-width: 140px;
}
.class-btn .btn-label:focus {
  text-decoration: underline;
  text-decoration-style: dashed;
  cursor: text;
}

/* â”€â”€ Content panel â”€â”€ */
.content-area {
  max-width: 860px;
  margin: 0 auto;
  padding: 40px 24px 80px;
}

.panel { display: none; }
.panel.active {
  display: block;
  animation: panelIn .25s ease both;
}
@keyframes panelIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* â”€â”€ Panel header â”€â”€ */
.panel-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 28px;
}
.panel-colour-bar {
  width: 6px;
  height: 52px;
  border-radius: 3px;
  flex-shrink: 0;
}
.panel-title {
  font-size: 1.8rem;
  font-weight: 800;
  letter-spacing: -0.03em;
  line-height: 1.1;
}
.panel-subtitle {
  font-size: 0.78rem;
  color: var(--muted);
  font-family: 'DM Mono', monospace;
  margin-top: 2px;
}
.panel-actions {
  margin-left: auto;
  display: flex;
  gap: 8px;
}
.copy-btn {
  background: var(--text);
  color: #fff;
  border: none;
  font-family: 'Outfit', sans-serif;
  font-size: 0.82rem;
  font-weight: 600;
  padding: 9px 18px;
  border-radius: 8px;
  cursor: pointer;
  transition: opacity .15s, transform .15s;
}
.copy-btn:hover { opacity: 0.85; transform: translateY(-1px); }
.copy-btn.copied { background: #22a85a; }

/* â”€â”€ Period table â”€â”€ */
.period-grid {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.period-row {
  display: grid;
  grid-template-columns: 56px 16px 1fr 1fr 1fr;
  gap: 0;
  background: var(--surface);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow);
  transition: box-shadow .15s;
}
.period-row:hover { box-shadow: var(--shadow-lg); }
.period-row.empty-row { opacity: 0.32; }

.period-row > div {
  padding: 14px 16px;
  display: flex;
  align-items: center;
  font-size: 0.88rem;
}
.period-row > div + div {
  border-left: 1px solid var(--border);
}

.cell-period {
  font-family: 'DM Mono', monospace;
  font-size: 0.78rem;
  font-weight: 500;
  color: var(--muted);
  letter-spacing: 0.04em;
  justify-content: center;
  background: var(--soft);
}
.cell-period.has-data {
  color: var(--text);
  font-weight: 700;
  font-size: 0.82rem;
}
.cell-dash {
  color: var(--border);
  justify-content: center;
  font-size: 0.7rem;
  padding: 14px 6px;
  flex-shrink: 0;
  border-left: none !important;
}
.cell-data {
  color: var(--text);
  font-weight: 500;
  word-break: break-word;
  line-height: 1.4;
}
.cell-data.empty {
  color: var(--muted);
  font-weight: 400;
  font-style: italic;
  font-size: 0.8rem;
}

/* â”€â”€ Colour accent bar on period row â”€â”€ */
.period-row .accent-bar {
  width: 4px;
  min-height: 100%;
  flex-shrink: 0;
  padding: 0;
  border-left: none !important;
}

/* â”€â”€ Controls bar â”€â”€ */
.controls-bar {
  max-width: 860px;
  margin: 0 auto 0;
  padding: 16px 24px 0;
  display: flex;
  justify-content: flex-end;
}
.clear-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--muted);
  font-family: 'Outfit', sans-serif;
  font-size: 0.8rem;
  padding: 6px 14px;
  border-radius: 8px;
  cursor: pointer;
  transition: border-color .2s, color .2s;
}
.clear-btn:hover { border-color: #e05151; color: #e05151; }

/* â”€â”€ Status â”€â”€ */
.status-bar {
  max-width: 860px;
  margin: 0 auto;
  padding: 10px 24px;
  font-family: 'DM Mono', monospace;
  font-size: 0.72rem;
  color: var(--muted);
}
.status-bar.err { color: #e05151; }

/* â”€â”€ Debug â”€â”€ */
.debug-box {
  max-width: 860px; margin: 16px auto; border: 1px solid var(--border);
  border-radius: 8px; overflow: hidden; display: none;
}
.debug-box.visible { display: block; }
.debug-header {
  background: var(--soft); padding: 8px 14px; font-size: 0.7rem;
  color: var(--muted); display: flex; justify-content: space-between;
  align-items: center; border-bottom: 1px solid var(--border);
  font-family: 'DM Mono', monospace;
}
.debug-toggle {
  background: none; border: 1px solid var(--border); color: var(--muted);
  font-family: 'DM Mono', monospace; font-size: 0.68rem; padding: 2px 8px;
  border-radius: 4px; cursor: pointer;
}
.debug-content {
  padding: 14px; font-size: 0.68rem; color: var(--muted); font-family: 'DM Mono', monospace;
  white-space: pre-wrap; word-break: break-all; max-height: 260px; overflow-y: auto;
}
</style>
</head>
<body>

<header class="site-header">
  <div class="site-title">Time<span> </span>Table</div>
  <div class="site-day" id="todayLabel"></div>
</header>

<!-- Paste screen -->
<div class="paste-wrap" id="pasteScreen">
  <div class="paste-zone" id="pasteZone" tabindex="0">
    <div class="paste-icon">ðŸ“‹</div>
    <h2>Paste your timetable</h2>
    <p>Open your Excel timetable Â· select all with <span class="key">Ctrl+A</span> Â· copy with <span class="key">Ctrl+C</span><br>then click here and press <span class="key">Ctrl+V</span></p>
  </div>
  <div class="status-bar" id="statusPaste"></div>
</div>

<!-- Main app -->
<div class="app" id="app">
  <div class="class-nav-wrap">
    <div class="class-nav" id="classNav"></div>
  </div>

  <div class="controls-bar">
    <button class="clear-btn" id="clearBtn">â†© Paste new timetable</button>
  </div>

  <div class="status-bar" id="statusApp"></div>

  <div class="content-area" id="contentArea"></div>
</div>

<div class="debug-box" id="debugBox">
  <div class="debug-header">
    <span>Raw clipboard HTML</span>
    <button class="debug-toggle" id="debugToggle">Show</button>
  </div>
  <div class="debug-content" id="debugContent" style="display:none"></div>
</div>

<script>
// â”€â”€ Date display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const now = new Date();
document.getElementById('todayLabel').textContent =
  DAYS[now.getDay()] + ' Â· ' + now.toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'});

// â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pasteScreen  = document.getElementById('pasteScreen');
const pasteZone    = document.getElementById('pasteZone');
const app          = document.getElementById('app');
const classNav     = document.getElementById('classNav');
const contentArea  = document.getElementById('contentArea');
const clearBtn     = document.getElementById('clearBtn');
const statusPaste  = document.getElementById('statusPaste');
const statusApp    = document.getElementById('statusApp');
const debugBox     = document.getElementById('debugBox');
const debugContent = document.getElementById('debugContent');
const debugToggle  = document.getElementById('debugToggle');

pasteZone.addEventListener('click', () => pasteZone.focus());
document.addEventListener('paste', handlePaste);

debugToggle.addEventListener('click', () => {
  const vis = debugContent.style.display !== 'none';
  debugContent.style.display = vis ? 'none' : 'block';
  debugToggle.textContent = vis ? 'Show' : 'Hide';
});

clearBtn.addEventListener('click', () => {
  app.classList.remove('visible');
  pasteScreen.style.display = '';
  classNav.innerHTML = '';
  contentArea.innerHTML = '';
  statusPaste.textContent = '';
  statusApp.textContent = '';
  debugBox.classList.remove('visible');
  debugContent.textContent = '';
});

// â”€â”€ Paste â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handlePaste(e) {
  const html = e.clipboardData.getData('text/html');
  if (html) {
    debugBox.classList.add('visible');
    debugContent.textContent = html.slice(0,12000) + (html.length>12000?'\nâ€¦truncated':'');
  }
  if (html && (html.includes('<td') || html.includes('<TD'))) {
    processHTMLData(html);
  } else {
    statusPaste.textContent = 'No table data found â€” copy directly from Excel (Ctrl+A Ctrl+C).';
    statusPaste.className = 'status-bar err';
  }
}

// â”€â”€ Colour helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EXCLUDED = new Set(['#ffffe1','#ffffe0','rgb(255,255,225)','rgb(255,255,224)']);
function isExcluded(c) { return EXCLUDED.has((c||'').toLowerCase().replace(/\s/g,'')); }
function isWhiteish(r,g,b) { return r>235 && g>235 && b>235; }
function isBlackish(r,g,b) { return r<20 && g<20 && b<20; }

function hexToRgb(hex) {
  hex = hex.replace('#','');
  if (hex.length===3) hex = hex.split('').map(c=>c+c).join('');
  if (hex.length!==6) return null;
  return {r:parseInt(hex.slice(0,2),16),g:parseInt(hex.slice(2,4),16),b:parseInt(hex.slice(4,6),16)};
}
const NAMED = {
  black:'0,0,0',white:'255,255,255',red:'255,0,0',lime:'0,255,0',blue:'0,0,255',
  yellow:'255,255,0',cyan:'0,255,255',magenta:'255,0,255',silver:'192,192,192',
  gray:'128,128,128',grey:'128,128,128',maroon:'128,0,0',olive:'128,128,0',
  green:'0,128,0',purple:'128,0,128',teal:'0,128,128',navy:'0,0,128',
  orange:'255,165,0',coral:'255,127,80',salmon:'250,128,114',khaki:'240,230,140',
  violet:'238,130,238',indigo:'75,0,130',turquoise:'64,224,208',tan:'210,180,140',
  aqua:'0,255,255',fuchsia:'255,0,255',
};
function normalizeColor(s) {
  if (!s) return null;
  s = s.trim().replace(/['"]/g,'');
  const skip = ['auto','transparent','none','windowtext','window','inherit','initial',''];
  if (skip.includes(s.toLowerCase())) return null;
  const rm = s.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);
  if (rm) { const [r,g,b]=[+rm[1],+rm[2],+rm[3]]; return isWhiteish(r,g,b)?null:`rgb(${r},${g},${b})`; }
  if (s.startsWith('#')) { const rgb=hexToRgb(s); if(!rgb) return null; return isWhiteish(rgb.r,rgb.g,rgb.b)?null:`#${s.replace('#','').toLowerCase().slice(0,6)}`; }
  const entry=NAMED[s.toLowerCase()]; if(entry){ const [r,g,b]=entry.split(',').map(Number); return isWhiteish(r,g,b)?null:`rgb(${r},${g},${b})`; }
  if(['white','fff','ffffff'].includes(s.toLowerCase())) return null;
  return s;
}
function normalizeTextColor(s) {
  if (!s) return null;
  s = s.trim().replace(/['"]/g,'');
  const skip = ['auto','windowtext','window','inherit','initial',''];
  if (skip.includes(s.toLowerCase())) return null;
  const rm = s.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);
  if (rm) { const [r,g,b]=[+rm[1],+rm[2],+rm[3]]; return isBlackish(r,g,b)?null:`rgb(${r},${g},${b})`; }
  if (s.startsWith('#')) { const rgb=hexToRgb(s); if(!rgb) return null; return isBlackish(rgb.r,rgb.g,rgb.b)?null:`#${s.replace('#','').toLowerCase().slice(0,6)}`; }
  if(['black','000','000000'].includes(s.toLowerCase())) return null;
  const entry=NAMED[s.toLowerCase()]; if(entry){ const [r,g,b]=entry.split(',').map(Number); return isBlackish(r,g,b)?null:`rgb(${r},${g},${b})`; }
  return null;
}
function extractBg(style) {
  if (!style) return null;
  for (const p of [/mso-highlight\s*:\s*([^;]+)/i,/background-color\s*:\s*([^;]+)/i,/background\s*:\s*([^;]+)/i]) {
    const m = style.match(p);
    if (m) { const val=m[1].trim(); const c=normalizeColor(val.split(/\s+/)[0])||normalizeColor(val); if(c) return c; }
  }
  return null;
}
function extractFg(style) {
  if (!style) return null;
  const m = style.match(/(?:^|;)\s*color\s*:\s*([^;]+)/i);
  return m ? normalizeTextColor(m[1].trim()) : null;
}
function cellColors(td, ccm, fgcm) {
  let bg = extractBg(td.getAttribute('style')||'');
  if (!bg) { for (const cls of (td.getAttribute('class')||'').split(/\s+/)) if(ccm[cls]){bg=ccm[cls];break;} }
  if (!bg) { const a=td.getAttribute('bgcolor'); if(a) bg=normalizeColor(a); }
  if (!bg) {
    const tr=td.closest('tr');
    if (tr) {
      bg=extractBg(tr.getAttribute('style')||'');
      if (!bg) { const a=tr.getAttribute('bgcolor'); if(a) bg=normalizeColor(a); }
      if (!bg) { for (const cls of (tr.getAttribute('class')||'').split(/\s+/)) if(ccm[cls]){bg=ccm[cls];break;} }
    }
  }
  let fg = extractFg(td.getAttribute('style')||'');
  if (!fg) { for (const cls of (td.getAttribute('class')||'').split(/\s+/)) if(fgcm[cls]){fg=fgcm[cls];break;} }
  return { bg:bg||null, fg:fg||null };
}

// â”€â”€ Luminance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getLuminance(c) {
  const n=(c||'').match(/\d+/g);
  return (!n||n.length<3)?999:0.299*+n[0]+0.587*+n[1]+0.114*+n[2];
}

// Returns a readable contrasting colour for a given bg
function contrastColor(bg) {
  const lum = getLuminance(bg);
  return lum > 140 ? '#1a1714' : '#ffffff';
}

function escapeHTML(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ Processing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const colorNames = {};
let currentGroupMap = null;

function processHTMLData(html) {
  const REF_ROW = 2;
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  const ccm={}, fgcm={};
  doc.querySelectorAll('style').forEach(el => {
    const re=/\.([a-zA-Z0-9_-]+)\s*\{([^}]+)\}/g; let m;
    while((m=re.exec(el.textContent))!==null){
      const bg=extractBg(m[2]); if(bg) ccm[m[1]]=bg;
      const fg=extractFg(m[2]); if(fg) fgcm[m[1]]=fg;
    }
  });

  const rows=doc.querySelectorAll('tr');
  if (!rows.length) { statusPaste.textContent='No rows found.'; statusPaste.className='status-bar err'; return; }

  const grid=[];
  rows.forEach(tr => {
    const row=[];
    tr.querySelectorAll('td,th').forEach(td => {
      const colspan=parseInt(td.getAttribute('colspan')||'1',10);
      const text=td.textContent.trim();
      const {bg,fg}=cellColors(td,ccm,fgcm);
      for(let s=0;s<colspan;s++) row.push({text,bg,fg});
    });
    grid.push(row);
  });

  const numCols=Math.max(...grid.map(r=>r.length));
  const refRow=grid[REF_ROW]||[];
  const periodNums=[];
  for(let c=0;c<numCols;c++){
    const txt=refRow[c]?refRow[c].text:'';
    const n=parseInt(txt,10);
    periodNums[c]=(n>=1&&n<=6)?n:null;
  }

  let dataStartCol=null;
  outerLoop:
  for(let c=0;c<numCols;c++){
    for(let r=0;r<grid.length;r++){
      if(r===REF_ROW) continue;
      const cell=grid[r][c];
      if(cell&&cell.bg&&!isExcluded(cell.bg)){dataStartCol=c;break outerLoop;}
    }
  }
  if(dataStartCol===null){
    statusPaste.textContent='No coloured cells found. Check raw HTML debug below.';
    statusPaste.className='status-bar err';
    return;
  }

  const groupMap=new Map();
  for(let r=0;r<grid.length;r++){
    if(r===REF_ROW) continue;
    const row=grid[r];
    for(let c=dataStartCol;c<numCols;c+=3){
      const c0=row[c]||{text:'',bg:null,fg:null};
      const c1=row[c+1]||{text:'',bg:null,fg:null};
      const c2=row[c+2]||{text:'',bg:null,fg:null};
      const bg=c0.bg;
      if(!bg||isExcluded(bg)) continue;
      const d1=c0.text,d2=c1.text,d3=c2.text;
      if(!d1&&!d2&&!d3) continue;
      const fg=c0.fg||null;
      const groupKey=bg+'||'+(fg||'');
      const periodNum=periodNums[c];
      if(!periodNum) continue;
      if(!groupMap.has(groupKey)) groupMap.set(groupKey,{bg,fg,slots:{}});
      const grp=groupMap.get(groupKey);
      if(!grp.slots[periodNum]) grp.slots[periodNum]=[];
      grp.slots[periodNum].push({d1,d2,d3});
    }
  }

  if(groupMap.size===0){
    statusPaste.textContent='No coloured groups found. Check raw HTML debug below.';
    statusPaste.className='status-bar err';
    return;
  }

  currentGroupMap=groupMap;
  renderApp(groupMap);
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderApp(groupMap) {
  classNav.innerHTML='';
  contentArea.innerHTML='';

  const sorted=[...groupMap.entries()].sort((a,b)=>getLuminance(a[1].bg)-getLuminance(b[1].bg));
  let firstId=null;

  sorted.forEach(([key,{bg,fg,slots}],gi)=>{
    const id='group-'+gi;
    if(gi===0) firstId=id;
    const savedName=colorNames[key]||'';
    const contrast=contrastColor(bg);

    // â”€â”€ Nav button â”€â”€
    const btn=document.createElement('button');
    btn.className='class-btn';
    btn.dataset.target=id;
    btn.dataset.key=key;

    const dot=document.createElement('span');
    dot.className='btn-dot';
    dot.style.background=bg;
    if(fg) dot.style.borderColor=fg;

    const label=document.createElement('span');
    label.className='btn-label';
    label.contentEditable='true';
    label.spellcheck=false;
    label.textContent=savedName||(gi===0?'Class 1':`Class ${gi+1}`);
    label.title='Click to rename';

    label.addEventListener('input',()=>{
      colorNames[key]=label.textContent.trim();
      // sync panel title
      const panelTitle=document.getElementById('title-'+id);
      if(panelTitle) panelTitle.textContent=label.textContent.trim()||`Class ${gi+1}`;
    });
    // prevent button click when editing label
    label.addEventListener('click', e => e.stopPropagation());
    label.addEventListener('keydown', e => { if(e.key==='Enter'){e.preventDefault();label.blur();} });

    btn.appendChild(dot);
    btn.appendChild(label);
    btn.addEventListener('click',()=>activateGroup(id));
    classNav.appendChild(btn);

    // â”€â”€ Content panel â”€â”€
    const panel=document.createElement('div');
    panel.className='panel';
    panel.id=id;

    // Period rows
    const rows=[1,2,3,4,5,6].map(p=>{
      const entries=slots[p];
      const isEmpty=!entries||entries.length===0;
      if(isEmpty){
        return `<div class="period-row empty-row">
          <div class="accent-bar" style="background:${bg}"></div>
          <div class="cell-period">P${p}</div>
          <div class="cell-dash">â€”</div>
          <div class="cell-data empty" style="grid-column:span 3"></div>
        </div>`;
      }
      return entries.map(({d1,d2,d3},idx)=>`
        <div class="period-row">
          <div class="accent-bar" style="background:${bg}"></div>
          <div class="cell-period has-data">P${p}</div>
          <div class="cell-dash">â€”</div>
          <div class="cell-data${d1?'':' empty'}">${escapeHTML(d1||'')}</div>
          <div class="cell-data${d2?'':' empty'}">${escapeHTML(d2||'')}</div>
          <div class="cell-data${d3?'':' empty'}">${escapeHTML(d3||'')}</div>
        </div>`).join('');
    }).join('');

    const displayName=savedName||(gi===0?'Class 1':`Class ${gi+1}`);
    const fgLabel=fg?` Â· <span style="font-family:'DM Mono',monospace;font-size:0.7rem">${escapeHTML(fg)}</span>`:'';

    panel.innerHTML=`
      <div class="panel-header">
        <div class="panel-colour-bar" style="background:${bg}${fg?`;box-shadow:2px 0 0 ${fg}`:''}"></div>
        <div>
          <div class="panel-title" id="title-${id}">${escapeHTML(displayName)}</div>
          <div class="panel-subtitle">${escapeHTML(bg)}${fgLabel}</div>
        </div>
        <div class="panel-actions">
          <button class="copy-btn" data-key="${escapeHTML(key)}">Copy P1â€“P6</button>
        </div>
      </div>
      <div class="period-grid">${rows}</div>
    `;

    // Copy handler
    panel.querySelector('.copy-btn').addEventListener('click',function(){
      const btn=this;
      const grpData=currentGroupMap.get(key);
      if(!grpData) return;
      const lines=[1,2,3,4,5,6].map(p=>{
        const ent=grpData.slots[p];
        if(!ent||ent.length===0) return `P${p} - \t\t`;
        return ent.map(({d1,d2,d3})=>`P${p} - ${d1}\t${d2}\t${d3}`).join('\n');
      });
      const text=lines.join('\n');
      navigator.clipboard.writeText(text).then(()=>flash(btn,'âœ“ Copied!','#22a85a')).catch(()=>{
        const ta=Object.assign(document.createElement('textarea'),{value:text,style:'position:fixed;opacity:0'});
        document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
        flash(btn,'âœ“ Copied!','#22a85a');
      });
    });

    contentArea.appendChild(panel);
  });

  // Show app, hide paste screen
  pasteScreen.style.display='none';
  app.classList.add('visible');
  statusApp.textContent=`${groupMap.size} class${groupMap.size!==1?'es':''} found Â· click a class to view`;

  if(firstId) activateGroup(firstId);
}

function activateGroup(id) {
  // Deactivate all
  document.querySelectorAll('.class-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  // Activate target
  const btn=document.querySelector(`.class-btn[data-target="${id}"]`);
  const panel=document.getElementById(id);
  if(btn) btn.classList.add('active');
  if(panel) panel.classList.add('active');
}

function flash(btn,msg,color){
  const orig=btn.textContent;
  btn.textContent=msg; btn.classList.add('copied');
  if(color) btn.style.background=color;
  setTimeout(()=>{btn.textContent=orig;btn.classList.remove('copied');btn.style.background='';},2000);
}
</script>
</body>
</html>
