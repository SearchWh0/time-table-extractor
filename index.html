<!DOCTYPE html>
<html>
<head>

<title>Timetable Extractor</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

</head>

<body>

<h2>Upload OR Paste Image</h2>

<input type="file" id="upload">

<p>OR press Ctrl+V to paste screenshot</p>

<canvas id="canvas"></canvas>

<br><br>

Selected Colour:

<input type="color" id="picker">

<button onclick="extract()">Extract Text</button>

<br><br>

<textarea id="output" rows="20" cols="80"></textarea>

<br>

<button onclick="download()">Download TXT</button>

<script>

let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");

let selectedColor = null;


// FILE UPLOAD

upload.onchange = function(e){

let img = new Image();

img.onload = function(){

canvas.width = img.width;
canvas.height = img.height;

ctx.drawImage(img,0,0);

}

img.src = URL.createObjectURL(e.target.files[0]);

}


// PASTE IMAGE

document.addEventListener("paste", function(e){

let items = e.clipboardData.items;

for (let item of items){

if (item.type.indexOf("image") !== -1){

let file = item.getAsFile();

let img = new Image();

img.onload = function(){

canvas.width = img.width;
canvas.height = img.height;

ctx.drawImage(img,0,0);

}

img.src = URL.createObjectURL(file);

}

}

});




// PICK COLOUR

canvas.onclick = function(e){

let pixel = ctx.getImageData(e.offsetX, e.offsetY, 1, 1).data;

selectedColor = pixel;

let hex = "#" +
((1 << 24) + (pixel[0] << 16) + (pixel[1] << 8) + pixel[2])
.toString(16).slice(1);

picker.value = hex;

}




// EXTRACT TEXT

function extract(){

if(!selectedColor){

alert("Click a colour first");

return;

}

let imgData = ctx.getImageData(0,0,canvas.width,canvas.height);

let data = imgData.data;


// isolate selected colour

for(let i=0;i<data.length;i+=4){

let r=data[i];
let g=data[i+1];
let b=data[i+2];

let diff =
Math.abs(r-selectedColor[0])+
Math.abs(g-selectedColor[1])+
Math.abs(b-selectedColor[2]);

if(diff>120){

data[i]=255;
data[i+1]=255;
data[i+2]=255;

}else{

data[i]=0;
data[i+1]=0;
data[i+2]=0;

}

}


ctx.putImageData(imgData,0,0);


// OCR

Tesseract.recognize(

canvas,

"eng",

{

tessedit_pageseg_mode: 6

}

).then(result=>{

output.value=result.data.text;

});


}



function download(){

let blob = new Blob([output.value]);

let a=document.createElement("a");

a.href=URL.createObjectURL(blob);

a.download="timetable.txt";

a.click();

}


</script>

</body>

</html>
